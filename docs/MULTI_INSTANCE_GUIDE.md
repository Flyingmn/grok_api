# AI Studio 多实例浏览器管理指南

## 概述

新的多实例系统支持同时运行多个浏览器实例，实现真正的并发图片生成。用户可以通过网页界面管理浏览器实例，生图任务的并发数等于运行中的浏览器实例数量。

## 🚀 快速开始

### 1. 启动服务

```bash
python scripts/start_multi_instance_server.py
```

这将启动两个服务：
- **图片生成API**: http://localhost:8812
- **浏览器管理界面**: http://localhost:8813

### 2. 管理浏览器实例

访问 http://localhost:8813 打开管理界面：

1. **创建实例**: 输入实例名称，点击"创建实例"
2. **启动实例**: 点击实例卡片中的"启动"按钮
3. **停止实例**: 点击"停止"按钮
4. **删除实例**: 停止后可以删除实例

### 3. 使用API生成图片

```python
import requests

# 生成图片
response = requests.post('http://localhost:8812/generate', json={
    "prompt": "一只可爱的小猫",
    "aspect_ratio": "16:9"
})

result = response.json()
print(f"任务状态: {result['success']}")
```

## 🏗️ 系统架构

### 核心组件

1. **BrowserManager**: 浏览器实例管理器
2. **BrowserInstance**: 单个浏览器实例
3. **AIStudioImageGenerator**: 支持并发的图片生成器
4. **管理界面**: 网页端浏览器管理

### 数据持久化

- **实例配置**: `data/browser_instances.json`
- **登录状态**: `data/cookies/{instance_id}_session.json`
- **日志文件**: `data/logs/`

## 📊 并发处理

### 并发逻辑

```
并发能力 = 运行中的浏览器实例数量
```

- 每个生图任务会自动分配到一个可用的浏览器实例
- 实例在处理任务时标记为"忙碌"状态
- 任务完成后实例恢复为"可用"状态

### 任务分配流程

```
1. 收到生图请求
   ↓
2. 查找可用的浏览器实例
   ↓
3. 标记实例为忙碌状态
   ↓
4. 执行生图任务
   ↓
5. 任务完成后释放实例
```

## 🎛️ 管理界面功能

### 实例统计

- **总实例数**: 创建的所有实例
- **运行中**: 正在运行的实例
- **可用实例**: 运行中且不忙碌的实例
- **并发能力**: 当前最大并发数

### 实例操作

- **创建**: 创建新的浏览器实例
- **启动**: 启动浏览器并初始化AI Studio
- **停止**: 停止浏览器实例
- **删除**: 删除实例配置（需先停止）

### 实例状态

- **stopped**: 已停止
- **starting**: 启动中
- **running**: 运行中
- **error**: 错误状态

## 🔧 API 接口

### 图片生成API

#### POST /generate
```json
{
    "prompt": "图片描述",
    "aspect_ratio": "16:9",
    "reference_image_b64": "base64图片数据（可选）"
}
```

#### GET /health
查看系统状态和实例信息

### 管理API

#### GET /api/instances
获取所有实例列表

#### POST /api/instances
创建新实例

#### POST /api/instances/{id}/start
启动实例

#### POST /api/instances/{id}/stop
停止实例

#### DELETE /api/instances/{id}
删除实例

## 💡 最佳实践

### 1. 实例数量规划

- **轻量使用**: 1-2个实例
- **中等负载**: 3-5个实例  
- **高并发**: 5-10个实例

### 2. 资源管理

- 每个浏览器实例约占用 200-500MB 内存
- 建议根据服务器配置合理设置实例数量
- 定期检查实例状态，重启异常实例

### 3. 登录管理

- 每个实例独立保存登录状态
- 首次启动需要手动登录Google账户
- 登录状态会自动保存和恢复

### 4. 错误处理

- 实例启动失败时会显示错误信息
- 可以重新启动失败的实例
- 删除有问题的实例重新创建

## 🔍 监控和调试

### 健康检查

```bash
curl http://localhost:8812/health
```

返回系统状态信息：
```json
{
    "status": "healthy",
    "browser_instances": {
        "total": 3,
        "running": 2,
        "available": 1,
        "busy": 1
    },
    "concurrency_capacity": 2,
    "active_tasks": 1
}
```

### 日志查看

- **API日志**: `data/logs/multi_instance_server_*.log`
- **浏览器日志**: 各实例独立的日志文件

### 常见问题

1. **实例启动失败**
   - 检查网络连接
   - 确认Google账户登录状态
   - 查看错误日志

2. **任务分配失败**
   - 确保有运行中的实例
   - 检查实例是否处于可用状态
   - 重启异常实例

3. **并发性能不佳**
   - 增加浏览器实例数量
   - 检查服务器资源使用情况
   - 优化实例配置

## 🚀 升级说明

### 从单实例升级

1. 停止旧的API服务
2. 启动新的多实例服务
3. 通过管理界面创建浏览器实例
4. 现有的cookies会自动迁移

### 配置迁移

- 旧的 `ai_studio_session.json` 会保留
- 新实例会使用 `{instance_id}_session.json` 格式
- 可以手动复制登录状态到新实例

## 📈 性能优化

### 并发优化

- 根据CPU核心数设置实例数量
- 监控内存使用情况
- 使用SSD存储提升性能

### 网络优化

- 确保稳定的网络连接
- 考虑使用代理提升访问速度
- 监控API响应时间

这个新系统提供了强大的并发能力和灵活的管理方式，让你可以根据需求动态调整浏览器实例数量，实现高效的图片生成服务！
